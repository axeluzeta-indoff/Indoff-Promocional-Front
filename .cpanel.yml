deployment:
  tasks:
    - /bin/echo "→ Activating Node venv"
    - source /home/indoff7/nodevenv/indoffpro_front_build/20/bin/activate

    - /bin/echo "→ Entering repo"
    - cd /home/indoff7/indoffpro_front

    # Asegura que NO esté en modo prod y sí instale dev deps
    - /bin/echo "→ Installing dependencies (with dev)"
    - /bin/bash -lc 'export NPM_CONFIG_PRODUCTION=false && npm ci --include=dev'

    - /bin/echo "→ Building"
    - npm run build

    - /bin/echo "→ Deploying dist/ to docroot"
    - /bin/rsync -a --delete dist/ /home/indoff7/indoffpro.com/

    # .htaccess SPA (si no existe)
    - /bin/test -f /home/indoff7/indoffpro.com/.htaccess || /bin/bash -lc 'cat > /home/indoff7/indoffpro.com/.htaccess << "EOF"
      RewriteEngine On
      RewriteBase /
      RewriteCond %{REQUEST_FILENAME} -f [OR]
      RewriteCond %{REQUEST_FILENAME} -d
      RewriteRule ^ - [L]
      RewriteRule . /index.html [L]
      <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresByType text/html "access plus 0 seconds"
        ExpiresByType text/css "access plus 7 days"
        ExpiresByType application/javascript "access plus 7 days"
        ExpiresByType image/webp "access plus 30 days"
        ExpiresByType image/png "access plus 30 days"
        ExpiresByType image/jpeg "access plus 30 days"
      </IfModule>
      EOF'
